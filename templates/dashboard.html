{% extends "base.html" %}

{% block title %}Dashboard - Bank Application{% endblock %}

{% block extra_css %}
<style>
    .icon-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    .transaction-item {
        transition: all 0.3s ease;
    }
    
    .transaction-item.new {
        background-color: rgba(25, 135, 84, 0.05);
        animation: highlight 2s ease-out;
    }
    
    @keyframes highlight {
        0% { background-color: rgba(25, 135, 84, 0.1); }
        100% { background-color: transparent; }
    }
    
    .transaction-amount.positive {
        color: #198754 !important;
    }
    
    .transaction-amount.negative {
        color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // This will be used by Socket.IO to update the UI in real-time
    document.addEventListener('DOMContentLoaded', function() {
        // Update account balance when receiving real-time updates
        const updateAccountBalance = (accountNumber, newBalance) => {
            const balanceElement = document.querySelector(`.account-balance[data-account='${accountNumber}']`);
            if (balanceElement) {
                balanceElement.textContent = '₹' + parseFloat(newBalance).toFixed(2);
            }
            
            // Update total balance
            const totalBalanceElement = document.getElementById('total-balance');
            if (totalBalanceElement) {
                // Recalculate total balance
                let total = 0;
                document.querySelectorAll('.account-balance').forEach(el => {
                    const balance = parseFloat(el.textContent.replace('₹', '').replace(/,/g, ''));
                    if (!isNaN(balance)) {
                        total += balance;
                    }
                });
                totalBalanceElement.textContent = '₹' + total.toFixed(2);
            }
        };

        // Format transaction amount with sign and currency
        function formatTransactionAmount(amount) {
            const isPositive = amount >= 0;
            const sign = isPositive ? '+' : '';
            const amountClass = isPositive ? 'positive' : 'negative';
            return `<span class="transaction-amount ${amountClass}">${sign}₹${Math.abs(amount).toFixed(2)}</span>`;
        }

        // Create a new transaction element
        function createTransactionElement(transaction) {
            const isCredit = transaction.amount >= 0;
            const transactionType = isCredit ? 'Credit' : 'Debit';
            const fromTo = isCredit 
                ? `From: ${transaction.from_account}` 
                : `To: ${transaction.to_account}`;
                
            const date = new Date(transaction.timestamp);
            const formattedDate = date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <div class="list-group-item list-group-item-action transaction-item new">
                    <div class="d-flex w-100 justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="icon-circle bg-${isCredit ? 'success' : 'danger'} text-white">
                                    <i class="fas fa-${isCredit ? 'arrow-down' : 'arrow-up'}"></i>
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-0">${transactionType}</h6>
                                <small class="text-muted">${formattedDate}</small>
                            </div>
                        </div>
                        <div class="text-end">
                            ${formatTransactionAmount(transaction.amount)}
                            <div><small class="text-muted">${fromTo}</small></div>
                        </div>
                    </div>
                </div>`;
        }

        // Add a new transaction to the top of the list
        function addNewTransaction(transaction) {
            const transactionsContainer = document.getElementById('recentTransactions');
            if (!transactionsContainer) return;
            
            // Create new transaction element
            const newTransaction = document.createElement('div');
            newTransaction.innerHTML = createTransactionElement(transaction);
            
            // Add the new transaction to the top
            if (transactionsContainer.firstChild) {
                transactionsContainer.insertBefore(newTransaction.firstChild, transactionsContainer.firstChild);
            } else {
                transactionsContainer.appendChild(newTransaction.firstChild);
            }
            
            // Remove the 'new' class after animation completes
            setTimeout(() => {
                newTransaction.firstChild.classList.remove('new');
            }, 2000);
            
            // Keep only the last 5 transactions
            while (transactionsContainer.children.length > 5) {
                transactionsContainer.removeChild(transactionsContainer.lastChild);
            }
        }

        // Listen for real-time updates
        if (typeof socket !== 'undefined') {
            // Handle balance updates
            socket.on('balance_update', function(data) {
                updateAccountBalance(data.account_number, data.new_balance);
            });
            
            // Handle new transactions
            socket.on('new_transaction', function(transaction) {
                // Check if this transaction is relevant to the current user
                const userAccounts = [{% for acc in accounts %}'{{ acc.account_number }}'{% if not loop.last %},{% endif %}{% endfor %}];
                if (userAccounts.includes(transaction.from_account) || userAccounts.includes(transaction.to_account)) {
                    // Format the transaction data
                    const formattedTx = {
                        ...transaction,
                        amount: userAccounts.includes(transaction.to_account) ? 
                            Math.abs(transaction.amount) : 
                            -Math.abs(transaction.amount),
                        transaction_type: userAccounts.includes(transaction.to_account) ? 'Credit' : 'Debit'
                    };
                    addNewTransaction(formattedTx);
                }
            });
        }
    });

    // Function to update account information when a different account is selected
    function updateAccountInfo() {
        const accountSelector = document.getElementById('accountSelector');
        const selectedIndex = accountSelector ? accountSelector.value : 0;
        const accountDetails = document.getElementById('accountDetails');
        
        // Get the account data from the template
        const accountsData = [
            {% for account in accounts %}
            {
                account_number: '{{ account.account_number|e }}',
                account_type: '{{ account.account_type|title|e }}',
                balance: {{ account.balance|tojson }},
                created_at: '{{ account.created_at.strftime("%d %b %Y") if account.created_at else "N/A"|e }}',
                status: 'Active',
                has_transactions: {{ (account.account_number in accounts_with_transactions)|tojson|lower }},
                last_transaction_date: '{% if account_last_dates.get(account.account_number) %}{{ account_last_dates[account.account_number].strftime("%d %b %Y") }}{% else %}No transactions{% endif %}'
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        if (accountDetails && accountsData[selectedIndex]) {
            const account = accountsData[selectedIndex];
            const lastTransaction = account.has_transactions ? 
                account.last_transaction_date : 'No transactions';
            
            // Update the account details section
            accountDetails.innerHTML = `
                <div class="account-info">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Account Number:</strong> <span class="float-end">${account.account_number}</span></p>
                            <p><strong>Account Type:</strong> <span class="float-end"><span class="badge bg-primary">${account.account_type}</span></span></p>
                            <p><strong>Balance:</strong> <span class="float-end account-balance" data-account="${account.account_number}">₹${account.balance.toFixed(2)}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> <span class="float-end"><span class="badge bg-success">${account.status}</span></span></p>
                            <p><strong>Opened On:</strong> <span class="float-end">${account.created_at}</span></p>
                            <p><strong>Last Transaction:</strong> <span class="float-end">${lastTransaction}</span></p>
                        </div>
                    </div>
                </div>
            `;
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="fas fa-home me-2"></i>Welcome, {{ user.full_name }}!
            </h2>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1" id="total-balance">₹{{ "%.2f"|format(total_balance) }}</h4>
                        <p class="mb-0">Total Balance</p>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">{{ accounts|length }}</h4>
                        <p class="mb-0">Total Accounts</p>
                    </div>
                    <i class="fas fa-credit-card fa-2x"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">{{ transactions|length }}</h4>
                        <p class="mb-0">Recent Transactions</p>
                    </div>
                    <i class="fas fa-history fa-2x"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">Quick Actions</h4>
                        <p class="mb-0">Transfer | UPI | History</p>
                    </div>
                    <i class="fas fa-bolt fa-2x"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Selection and Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-university me-2"></i>Account Information</h5>
                </div>
                <div class="card-body">
                    {% if accounts|length > 1 %}
                        <div class="mb-4">
                            <label for="accountSelector" class="form-label">Select Account</label>
                            <select class="form-select" id="accountSelector" onchange="updateAccountInfo()">
                                {% for account in accounts %}
                                    <option value="{{ loop.index0 }}" {% if loop.first %}selected{% endif %}>
                                        {{ account.account_type|title }} - {{ account.account_number }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}
                    
                    <div id="accountDetails">
                        {% if accounts %}
                            {% set account = accounts[0] %}
                            <div class="account-info">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Account Number:</strong> <span class="float-end">{{ account.account_number }}</span></p>
                                        <p><strong>Account Type:</strong> <span class="float-end"><span class="badge bg-primary">{{ account.account_type|title }}</span></span></p>
                                        <p><strong>Balance:</strong> <span class="float-end account-balance" data-account="{{ account.account_number }}">₹{{ "%.2f"|format(account.balance) }}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> <span class="float-end"><span class="badge bg-success">Active</span></span></p>
                                        <p><strong>Opened On:</strong> <span class="float-end">{{ account.created_at.strftime('%d %b %Y') if account.created_at else 'N/A' }}</span></p>
                                        <p><strong>Last Transaction:</strong> <span class="float-end">
                                            {% if transactions %}
                                                {{ transactions[0].created_at.strftime('%d %b %Y') if transactions[0].created_at else 'N/A' }}
                                            {% else %}
                                                No transactions
                                            {% endif %}
                                        </span></p>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No accounts found</p>
                                <a href="{{ url_for('add_account') }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Add Account
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accounts Table (Hidden if more than one account) -->
    {% if accounts|length > 1 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Accounts</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Account Number</th>
                                    <th>Type</th>
                                    <th>Balance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in accounts %}
                                <tr>
                                    <td><code>{{ account.account_number }}</code></td>
                                    <td>
                                        <span class="badge bg-primary">{{ account.account_type|title }}</span>
                                    </td>
                                    <td>
                                        <strong class="account-balance" data-account="{{ account.account_number }}">
                                            ₹{{ "%.2f"|format(account.balance) }}
                                        </strong>
                                    </td>
                                    <td>
                                        <form action="{{ url_for('delete_account', account_number=account.account_number) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this account? This will also delete all transactions for this account.');" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash-alt"></i> Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{{ url_for('add_account') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-plus-circle me-2"></i>Add Account
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('transfer') }}" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-exchange-alt me-2"></i>Transfer Money
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('upi_payment') }}" class="btn btn-outline-info w-100 mb-2">
                                <i class="fas fa-mobile-alt me-2"></i>UPI Payment
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('transactions') }}" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-history me-2"></i>View History
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 